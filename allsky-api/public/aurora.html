<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Allsky360 Aurora</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Allsky360 Aurora">
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="stylesheet" href="style.css">
  <!-- Gridstack CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@9.2.2/dist/gridstack.min.css">
  
  <script src="js/allsky-common.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <!-- Gridstack JS (IIFE bundle: core + HTML5 drag&drop) -->
  <script src="https://cdn.jsdelivr.net/npm/gridstack@9.2.2/dist/gridstack-all.js" defer></script>
</head>

<body>
  <div id="header">
    <div class="title-icon">
      <img src="allsky360_256x256.png" alt="Allsky Icon" width="32" height="32" />
      <h1>Allsky360 Aurora</h1>
    </div>

        <!-- Hamburger Menu Button -->
    <button id="hamburger-menu-btn" class="hamburger-menu-btn" onclick="toggleHamburgerMenu()">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    
    <!-- Navigation Menu -->
    <nav id="nav-menu" class="nav-menu">
      <ul class="nav-list">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="archive.html" class="nav-link">Archive</a></li>
        <li><a href="videos.html" class="nav-link">Videos</a></li>
        <li><a href="graphs.html" class="nav-link">Graphs</a></li>
        <li><a href="meteo.html" class="nav-link">Weather</a></li>
        <li><a href="aurora.html" class="nav-link">Aurora</a></li>
        <li><a href="config.html" class="nav-link">Config</a></li>
        <li><a href="calibration.html" class="nav-link">Calibration</a></li>
        <li><a href="processing.html" class="nav-link">Processing</a></li>
      </ul>
    </nav>
  </div>
  <div id="subheader">
    <div class="settings-groups">
      <label style="display: flex; align-items: center; gap: 0.3rem;">
        Select date:
        <input type="date" id="datePicker">
      </label>
    </div>
  </div>
  <!-- Grid Layout -->
  <div class="grid-stack" id="aurora-grid" style="margin: 8px;">
    <!-- Aurora Probability Chart Widget (Combined) -->
    <div class="grid-stack-item" gs-id="chart-probability-combined" gs-x="0" gs-y="0" gs-w="12" gs-h="4">
      <div class="grid-stack-item-content">
        <canvas id="chartProbabilityCombined"></canvas>
      </div>
    </div>

    <!-- Kp Index Chart Widget -->
    <div class="grid-stack-item" gs-id="chart-kp-index" gs-x="0" gs-y="4" gs-w="6" gs-h="3">
      <div class="grid-stack-item-content">
        <canvas id="chartKpIndex"></canvas>
      </div>
    </div>

    <!-- Bt (Magnetic Field Total) Chart Widget -->
    <div class="grid-stack-item" gs-id="chart-bt" gs-x="6" gs-y="4" gs-w="6" gs-h="3">
      <div class="grid-stack-item-content">
        <canvas id="chartBt"></canvas>
      </div>
    </div>

    <!-- Bz (Magnetic Field Z-Component) Chart Widget -->
    <div class="grid-stack-item" gs-id="chart-bz" gs-x="0" gs-y="7" gs-w="6" gs-h="3">
      <div class="grid-stack-item-content">
        <canvas id="chartBz"></canvas>
      </div>
    </div>

    <!-- Solar Wind Density Chart Widget -->
    <div class="grid-stack-item" gs-id="chart-density" gs-x="6" gs-y="7" gs-w="6" gs-h="3">
      <div class="grid-stack-item-content">
        <canvas id="chartDensity"></canvas>
      </div>
    </div>

    <!-- Solar Wind Speed Chart Widget -->
    <div class="grid-stack-item" gs-id="chart-speed" gs-x="0" gs-y="10" gs-w="6" gs-h="3">
      <div class="grid-stack-item-content">
        <canvas id="chartSpeed"></canvas>
      </div>
    </div>

    <!-- Solar Wind Temperature Chart Widget -->
    <div class="grid-stack-item" gs-id="chart-temperature" gs-x="6" gs-y="10" gs-w="6" gs-h="3">
      <div class="grid-stack-item-content">
        <canvas id="chartTemperature"></canvas>
      </div>
    </div>
  </div>

  <footer id="footer">
    <div style="text-align:center; width:100%;">Copyright (c) 2025 Sven Kreiensen</div>
    <button id="toggle-grid-btn" style="position:absolute; right:120px;" title="Widgets verschieben/vergrÃ¶ÃŸern aktivieren/deaktivieren" onclick="toggleGridInteraction()">ðŸ”’ Locked</button>
    <button id="reset-layout-btn" style="position:absolute; right:0;" title="Layout auf Standard zurÃ¼cksetzen" onclick="resetGridLayout()">Reset layout</button>
  </footer>

  <script>
    const charts = {};

    function createChart(id, label, datasets, type = "line", showLegend = false, yAxisMin = null, yAxisMax = null) {
      const options = {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: { unit: 'minute', displayFormats: { hour: 'HH:mm', minute: 'HH:mm' }, tooltipFormat: 'HH:mm' },
            ticks: { color: 'white' },
            grid: { color: '#444' }
          },
          y: {
            ticks: {
              color: 'white',
              callback: (v) => Number.isInteger(v) ? v.toString() : v.toFixed(1)
            },
            grid: { color: '#444' }
          }
        },
        plugins: {
          title: { display: true, text: label, color: 'white' },
          legend: { display: showLegend, labels: { color: 'white' } }
        }
      };

      // Y-Achsen-Bereich setzen falls angegeben
      if (yAxisMin !== null || yAxisMax !== null) {
        options.scales.y.min = yAxisMin;
        options.scales.y.max = yAxisMax;
      }

      return new Chart(document.getElementById(id), {
        type,
        data: { labels: [], datasets },
        options
      });
    }

    function updateCharts(data) {
      const ts = data.map(d => new Date(d.timestamp * 1000));

      // Aurora Probability Combined Chart
      charts.chartProbabilityCombined.data.labels = ts;
      charts.chartProbabilityCombined.data.datasets[0].data = data.map(d => d.probability_percent);
      charts.chartProbabilityCombined.data.datasets[1].data = data.map(d => d.probability_max);
      charts.chartProbabilityCombined.data.datasets[2].data = data.map(d => d.probability_avg);

      // Kp Index
      charts.chartKpIndex.data.labels = ts;
      charts.chartKpIndex.data.datasets[0].data = data.map(d => d.kp_index);

      // Magnetic Field Components
      charts.chartBt.data.labels = ts;
      charts.chartBt.data.datasets[0].data = data.map(d => d.bt);

      charts.chartBz.data.labels = ts;
      charts.chartBz.data.datasets[0].data = data.map(d => d.bz);

      // Solar Wind Parameters
      charts.chartDensity.data.labels = ts;
      charts.chartDensity.data.datasets[0].data = data.map(d => d.density);

      charts.chartSpeed.data.labels = ts;
      charts.chartSpeed.data.datasets[0].data = data.map(d => d.speed);

      charts.chartTemperature.data.labels = ts;
      charts.chartTemperature.data.datasets[0].data = data.map(d => d.temperature);

      Object.values(charts).forEach(chart => chart.update());
    }

    function clearAllCharts() {
      Object.values(charts).forEach(chart => {
        chart.data.labels = [];
        chart.data.datasets.forEach(ds => ds.data = []);
        chart.update();
      });
    }

    async function loadMeasurements() {
      try {
        const date = document.getElementById("datePicker").value;
        const res = await fetch(`/api/aurora?date=${date}`);

        if (res.status === 404) {
          console.warn("No data for this date. Clearing charts.");
          clearAllCharts();
          return;
        }

        if (!res.ok) throw new Error("Fetch error");

        const json = await res.json();
        if (Array.isArray(json)) {
          updateCharts(json);
        } else {
          clearAllCharts();
        }
      } catch (err) {
        console.error("Failed to load measurement data:", err);
        clearAllCharts();
      }
    }

    function init() {
      const datePicker = document.getElementById("datePicker");
      datePicker.value = new Date().toISOString().slice(0, 10);
      datePicker.addEventListener("change", loadMeasurements);

      // Aurora Probability Combined Chart
      charts.chartProbabilityCombined = createChart("chartProbabilityCombined", "Aurora Probability (%)", [
        { label: "Probability %", data: [], borderColor: "#00ff88", backgroundColor: "#00ff8820", fill: true, pointRadius: 0 },
        { label: "Max Probability %", data: [], borderColor: "#ff6600", fill: false, pointRadius: 0 },
        { label: "Avg Probability %", data: [], borderColor: "#ffaa00", fill: false, pointRadius: 0 }
      ], "line", true, 0, 100);

      // Kp Index
      charts.chartKpIndex = createChart("chartKpIndex", "Kp Index", [
        { label: "Kp Index", data: [], borderColor: "#ff2288", backgroundColor: "#ff228820", fill: true, pointRadius: 0 }
      ], "bar", false);

      // Magnetic Field Components
      charts.chartBt = createChart("chartBt", "Bt (Magnetic Field Total)", [
        { label: "Bt", data: [], borderColor: "#4488ff", fill: false, pointRadius: 0 }
      ]);

      charts.chartBz = createChart("chartBz", "Bz (Magnetic Field Z)", [
        { label: "Bz", data: [], borderColor: "#88aaff", fill: false, pointRadius: 0 }
      ]);

      // Solar Wind Parameters
      charts.chartDensity = createChart("chartDensity", "Solar Wind Density", [
        { label: "Density", data: [], borderColor: "#aa44ff", fill: false, pointRadius: 0 }
      ]);

      charts.chartSpeed = createChart("chartSpeed", "Solar Wind Speed", [
        { label: "Speed", data: [], borderColor: "#ff4444", fill: false, pointRadius: 0 }
      ]);

      charts.chartTemperature = createChart("chartTemperature", "Solar Wind Temperature", [
        { label: "Temperature", data: [], borderColor: "#ffaa44", fill: false, pointRadius: 0 }
      ]);

      loadMeasurements();
      setInterval(loadMeasurements, 60000); // 60s update
    }

    document.addEventListener("DOMContentLoaded", init);

    // Gridstack Initialisierung und Layout-Persistenz
    document.addEventListener('DOMContentLoaded', () => {
      const gridEl = document.getElementById('aurora-grid');
      const grid = GridStack.init({
        cellHeight: 110,
        disableOneColumnMode: false,
        float: false,
        resizable: { handles: 'all' }
      }, gridEl);

      // Grid-Interaktion Status
      let gridInteractionEnabled = false;
      const toggleBtn = document.getElementById('toggle-grid-btn');

      // Widgets standardmÃ¤ÃŸig sperren
      grid.enableMove(false);
      grid.enableResize(false);

      // Toggle-Funktion fÃ¼r Grid-Interaktion
      window.toggleGridInteraction = function() {
        gridInteractionEnabled = !gridInteractionEnabled;
        
        if (gridInteractionEnabled) {
          // Aktiviert: Widgets kÃ¶nnen verschoben und vergrÃ¶ÃŸert werden
          grid.enableMove(true);
          grid.enableResize(true);
          toggleBtn.textContent = 'ðŸ”“ Unlocked';
          toggleBtn.title = 'Widgets verschieben/vergrÃ¶ÃŸern deaktivieren';
        } else {
          // Deaktiviert: Widgets sind gesperrt
          grid.enableMove(false);
          grid.enableResize(false);
          toggleBtn.textContent = 'ðŸ”’ Locked';
          toggleBtn.title = 'Widgets verschieben/vergrÃ¶ÃŸern aktivieren';
        }
      };

      const LS_KEY = 'allsky360.aurora.layout.v1';
      const defaultLayout = [
        {"id":"chart-probability-combined","x":0,"y":0,"w":12,"h":4},
        {"id":"chart-kp-index","x":0,"y":4,"w":6,"h":3},
        {"id":"chart-bt","x":6,"y":4,"w":6,"h":3},
        {"id":"chart-bz","x":0,"y":7,"w":6,"h":3},
        {"id":"chart-density","x":6,"y":7,"w":6,"h":3},
        {"id":"chart-speed","x":0,"y":10,"w":6,"h":3},
        {"id":"chart-temperature","x":6,"y":10,"w":6,"h":3}
      ];

      function applyLayout(layout) {
        const items = grid.engine.nodes; // current nodes
        const byId = Object.fromEntries(items.map(n => [n.id || n.el.getAttribute('gs-id'), n]));
        layout.forEach(l => {
          const node = byId[l.id];
          if (!node) return;
          grid.update(node.el, { x: l.x, y: l.y, w: l.w, h: l.h });
        });
      }

      function loadLayout() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return null;
          return parsed;
        } catch (e) { return null; }
      }

      function saveLayout() {
        const data = grid.save(true).map(n => ({ id: n.id || n.el.getAttribute('gs-id'), x: n.x, y: n.y, w: n.w, h: n.h }));
        try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch (_) {}
      }

      window.resetGridLayout = function() {
        applyLayout(defaultLayout);
        try { localStorage.removeItem(LS_KEY); } catch (_) {}
      }

      // beim Start: gespeichertes Layout anwenden oder Default
      const saved = loadLayout();
      applyLayout(saved || defaultLayout);

      grid.on('change', saveLayout);
    });
  </script>
  <footer id="footer">
    <div class="copyright">Copyright (c) 2025 Sven Kreiensen</div>
  </footer>
</body>

</html>
